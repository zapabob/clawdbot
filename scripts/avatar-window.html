<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Hakua Avatar</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      background: transparent;
      overflow: hidden;
      width: 100vw;
      height: 100vh;
    }
    #canvas-container {
      width: 100%;
      height: 100%;
      position: relative;
    }
    canvas {
      display: block;
      width: 100%;
      height: 100%;
    }
    #status {
      position: absolute;
      bottom: 8px;
      left: 8px;
      color: rgba(255,255,255,0.7);
      font-family: monospace;
      font-size: 11px;
      pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
    #sbv2-status {
      position: absolute;
      top: 8px;
      right: 8px;
      color: rgba(100,255,150,0.9);
      font-family: monospace;
      font-size: 10px;
      pointer-events: none;
      text-shadow: 0 1px 2px rgba(0,0,0,0.8);
    }
  </style>
</head>
<body>
  <div id="canvas-container">
    <canvas id="avatar-canvas"></canvas>
    <div id="status">Loading Hakua.fbx...</div>
    <div id="sbv2-status">SBV2: checking...</div>
  </div>

  <script type="importmap">
    {
      "imports": {
        "three": "https://cdn.jsdelivr.net/npm/three@0.169.0/build/three.module.js",
        "three/addons/": "https://cdn.jsdelivr.net/npm/three@0.169.0/examples/jsm/"
      }
    }
  </script>

  <script type="module">
    import * as THREE from 'three';
    import { FBXLoader } from 'three/addons/loaders/FBXLoader.js';
    import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

    const canvas = document.getElementById('avatar-canvas');
    const statusEl = document.getElementById('status');
    const sbv2El = document.getElementById('sbv2-status');

    // --- Renderer ---
    const renderer = new THREE.WebGLRenderer({
      canvas,
      antialias: true,
      alpha: true,
    });
    renderer.setPixelRatio(window.devicePixelRatio);
    renderer.setSize(window.innerWidth, window.innerHeight);
    renderer.shadowMap.enabled = true;
    renderer.shadowMap.type = THREE.PCFSoftShadowMap;
    renderer.outputColorSpace = THREE.SRGBColorSpace;

    // --- Scene ---
    const scene = new THREE.Scene();

    // --- Camera ---
    const camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
    camera.position.set(0, 1.5, 3.0);
    camera.lookAt(0, 1.0, 0);

    // --- Lights ---
    const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
    scene.add(ambientLight);

    const dirLight = new THREE.DirectionalLight(0xffffff, 1.2);
    dirLight.position.set(2, 5, 3);
    dirLight.castShadow = true;
    dirLight.shadow.mapSize.width = 2048;
    dirLight.shadow.mapSize.height = 2048;
    scene.add(dirLight);

    const fillLight = new THREE.DirectionalLight(0x88ccff, 0.4);
    fillLight.position.set(-2, 2, -1);
    scene.add(fillLight);

    // --- Controls ---
    const controls = new OrbitControls(camera, canvas);
    controls.enableDamping = true;
    controls.dampingFactor = 0.05;
    controls.target.set(0, 1.0, 0);
    controls.minDistance = 1.0;
    controls.maxDistance = 8.0;
    controls.maxPolarAngle = Math.PI / 1.5;

    // --- FBX Loader ---
    const loader = new FBXLoader();
    let mixer = null;
    let model = null;
    let idleAction = null;

    // FBX path - relative to this HTML file location
    const fbxPath = '../assets/NFD/Hakua/FBX/Hakua.fbx';

    loader.load(
      fbxPath,
      (fbx) => {
        model = fbx;

        // Auto-scale: normalize to ~1.7m height
        const box = new THREE.Box3().setFromObject(fbx);
        const size = box.getSize(new THREE.Vector3());
        const targetHeight = 1.7;
        const scale = targetHeight / size.y;
        fbx.scale.setScalar(scale);

        // Center on ground
        const center = box.getCenter(new THREE.Vector3());
        fbx.position.x = -center.x * scale;
        fbx.position.y = -box.min.y * scale;
        fbx.position.z = -center.z * scale;

        fbx.traverse((child) => {
          if (child.isMesh) {
            child.castShadow = true;
            child.receiveShadow = true;
          }
        });

        scene.add(fbx);

        // Animation mixer
        if (fbx.animations && fbx.animations.length > 0) {
          mixer = new THREE.AnimationMixer(fbx);
          idleAction = mixer.clipAction(fbx.animations[0]);
          idleAction.play();
          statusEl.textContent = `Hakua loaded (${fbx.animations.length} animations)`;
        } else {
          statusEl.textContent = 'Hakua loaded (no animations)';
        }
      },
      (progress) => {
        if (progress.total > 0) {
          const pct = Math.round(progress.loaded / progress.total * 100);
          statusEl.textContent = `Loading Hakua.fbx... ${pct}%`;
        }
      },
      (err) => {
        console.error('FBX load error:', err);
        statusEl.textContent = `FBX error: ${err.message}`;
        // Show fallback placeholder cube
        const geo = new THREE.BoxGeometry(0.5, 1.7, 0.3);
        const mat = new THREE.MeshLambertMaterial({ color: 0xccaaff });
        const placeholder = new THREE.Mesh(geo, mat);
        placeholder.position.y = 0.85;
        scene.add(placeholder);
        statusEl.textContent = 'Placeholder avatar (FBX not found)';
      }
    );

    // --- SBV2 status check ---
    async function checkSbv2() {
      try {
        const res = await fetch('http://localhost:5000/status', { signal: AbortSignal.timeout(2000) });
        if (res.ok) {
          sbv2El.textContent = 'SBV2: âœ“ online';
          sbv2El.style.color = 'rgba(100,255,150,0.9)';
        } else {
          sbv2El.textContent = `SBV2: ${res.status}`;
          sbv2El.style.color = 'rgba(255,200,100,0.9)';
        }
      } catch {
        sbv2El.textContent = 'SBV2: offline';
        sbv2El.style.color = 'rgba(255,120,120,0.9)';
      }
    }
    checkSbv2();
    setInterval(checkSbv2, 10000);

    // --- Breathing idle animation (when no FBX animation) ---
    let t = 0;

    // --- Render loop ---
    const clock = new THREE.Clock();
    function animate() {
      requestAnimationFrame(animate);
      const delta = clock.getDelta();
      t += delta;

      controls.update();

      if (mixer) {
        mixer.update(delta);
      } else if (model) {
        // Gentle breathing bob
        model.position.y += Math.sin(t * 1.5) * 0.0002;
      }

      renderer.render(scene, camera);
    }
    animate();

    // --- Resize handler ---
    window.addEventListener('resize', () => {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    });

    // --- Keyboard shortcuts ---
    window.addEventListener('keydown', (e) => {
      if (e.key === 'r' || e.key === 'R') {
        // Reset camera
        camera.position.set(0, 1.5, 3.0);
        controls.target.set(0, 1.0, 0);
        controls.update();
      }
    });
  </script>
</body>
</html>
