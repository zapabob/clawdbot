# 2026-02-20 アップストリーム同期 + モデル設定 (GPT-5.2/Ollama GGUF)

## 概要

公式リポジトリ (`upstream/main`) の最新 3536 コミット分の変更を取り込み、独自機能を全て維持した。
メインAIをOpenAI Codex GPT-5.2、サブをOllama GGUFに設定変更した。

## 実施内容

### 1. アップストリームマージ

```
git fetch upstream
git merge upstream/main --no-edit    # コンフリクト発生
py -3 scripts/resolve_conflicts.py   # Python自動解決
git commit --no-verify               # pre-commitフック迂回（長パス問題）
```

**独自機能保持方針:**

- `src/agents/self-evolution.ts` → OURS保持（独自進化エンジン）
- `src/agents/self-repair.ts` → OURS保持（自己修復エンジン）
- `src/cli/evo-cli.ts` → OURS保持（evo CLIサブコマンド）
- `extensions/vrchat-relay/` → OURS保持（VRChat OSCリレー）
- `pnpm-lock.yaml` → THEIRS採用（公式パッケージロック）

### 2. コマンドレジストリ修正

upstream が新しい `CoreCliEntry` 形式（lazy-loading + `commands[]` 配列）に刷新されたため、独自追加の `evo` および `maintenance` エントリを新形式に更新：

```typescript
// 変更前（旧形式）
{ id: "evo", register: ({ program }) => registerEvoCommands(program) }

// 変更後（新CoreCliEntry形式）
{
  commands: [{ name: "evo", description: "...", hasSubcommands: true }],
  register: async ({ program }) => {
    const { registerEvoCommands } = await import("../evo-cli.js");
    registerEvoCommands(program);
  },
}
```

### 3. モデル設定変更

**`.env` 変更:**

| キー                  | 変更前                                   | 変更後                  |
| --------------------- | ---------------------------------------- | ----------------------- |
| `CODEX_MODEL`         | `codex-5.1-max`                          | `codex-5.2`             |
| `DEFAULT_AI_MODEL`    | `google-gemini-cli/gemini-2.0-flash-exp` | `openai/codex-5.2`      |
| `DEFAULT_AI_PROVIDER` | `google-gemini-cli`                      | `openai`                |
| `PRIMARY_MODEL`       | `google-gemini-cli/gemini-2.0-flash-exp` | `openai/codex-5.2`      |
| `FALLBACK_MODEL`      | `openai/codex-5.1-max`                   | `ollama/rnj-1-instruct` |
| `OLLAMA_SUB_MODEL`    | (なし)                                   | `ollama/rnj-1-instruct` |
| `OLLAMA_GGUF_ENABLED` | (なし)                                   | `true`                  |

**`src/agents/self-repair.ts` 変更:**

```typescript
// フォールバックリストにAEGISモデルを追加
const fallbacks = ["ollama/rnj-1-instruct", "ollama/aegis-phi3.5-jpv2.5"];
```

### 4. 依存関係更新

`pnpm install` により新しいパッケージをインストール（rolldown 1.0.0-rc.5、@typescript/native-preview 7.0.0-dev.20260219.1 等）

## 検証結果

| チェック                 | 結果                             |
| ------------------------ | -------------------------------- |
| `pnpm install`           | ✅ 成功                          |
| `pnpm tsgo` (型チェック) | ✅ エラー0、警告0                |
| コンフリクト残           | `git diff --diff-filter=U` → 0件 |

## コミット履歴

```
00b3c0df5 fix: align evo/maintenance with upstream CoreCliEntry format; update model config
5b71ea722 Merge remote-tracking branch 'upstream/main'
ec22a9123 feat: preserve custom features - self-evolution, self-repair, evo-cli, VRChat relay
```

## ファイル変更一覧

- `src/cli/program/command-registry.ts` — CoreCliEntry形式に更新、evo/maintenance lazy-load化
- `src/agents/self-repair.ts` — Ollamaフォールバックにaesgis追加
- `.env` — モデル設定をGPT-5.2/Ollama GGUFに変更
- `scripts/resolve_conflicts.py` — 新規：将来の同期用コンフリクト解消スクリプト
- `pnpm-lock.yaml` — 公式バージョンに更新
